<!DOCTYPE html>  
<html lang="id">  
<head>  
    <meta charset="UTF-8" />  
    <meta name="viewport" content="width=device-width, initial-scale=1" />  
    <title>Aplikasi Input Invoice - Firman Grup</title>  
    <style>  
        /* (Semua CSS Anda tetap sama) */  
        @font-face {  
            font-family: 'CustomFont';  
            src: url('/mnt/data/file-ngwyeoEN29l1M3O1QpdxCwkj');  
        }  
        body {  
            font-family: 'CustomFont', Arial, sans-serif;  
            background-color: #f5f5f5;  
            margin: 0;  
            padding: 20px;  
            font-size: 14px;  
        }  
        .container {  
            max-width: 800px;  
            margin: auto;  
            background: #fff;  
            padding: 20px;  
            border-radius: 8px;  
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);  
        }  
        h1 {  
            text-align: center;  
            margin-bottom: 20px;  
            font-size: 24px;  
        }  
        h2 {  
            text-align: left;  
            margin: 15px 0 5px 0;  
            font-size: 16px;  
            border-bottom: 1px solid #eee;  
            padding-bottom: 5px;  
        }  
        /* ... semua CSS lain tetap sama ... */  
        
        #loginContainer {  
            max-width: 400px;   
            margin: 100px auto;   
            background: white;   
            padding: 30px;   
            border-radius: 8px;   
            box-shadow: 0 0 10px rgba(0,0,0,0.1);  
            text-align: center;  
        }  
        #loginContainer input {  
            width: 100%;  
            padding: 8px;  
            margin: 8px 0;  
            font-size: 14px;  
            border-radius: 4px;  
            border: 1px solid #ccc;  
            box-sizing: border-box;  
        }  
        #loginContainer button {  
            width: 100%;  
            padding: 10px;  
            background:#007bff;  
            color: white;  
            font-size: 16px;  
            border:none;  
            border-radius:4px;  
            cursor:pointer;  
        }  
        #loginContainer button:hover {  
            background:#0056b3;  
        }  
        #errorMessage {  
            color: red;  
            margin-top: 10px;  
            min-height: 18px;  
        }  
        #logoutBtn {  
            float: right;  
            margin: 10px 20px 0 0;  
            background: #dc3545;  
            border: none;  
            padding: 8px 12px;  
            color: white;  
            font-size: 14px;  
            border-radius: 4px;  
            cursor: pointer;  
        }  
        #logoutBtn:hover {  
            background: #a71d2a;  
        }  
    </style>  

    <!-- Firebase SDK & Initialization -->  
    <script type="module">  
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";  
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";  
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";  

        const firebaseConfig = {  
          apiKey: "AIzaSyCRm31FJaqEbjL_MqMKKiiQRlurYenc4Dc",  
          authDomain: "project-baru-28a4a.firebaseapp.com",  
          projectId: "project-baru-28a4a",  
          storageBucket: "project-baru-28a4a.appspot.com",  
          messagingSenderId: "1046595689835",  
          appId: "1:1046595689835:web:5c7eb22e357e36ff11802e",  
          measurementId: "G-2ZGYXQDLW9"  
        };  

        // Initialize Firebase  
        const app = initializeApp(firebaseConfig);  
        const auth = getAuth(app);  
        const db = getFirestore(app);  

        // Expose globally for other functions  
        window.auth = auth;  
        window.db = db;  

        // After DOM loaded  
        window.addEventListener('DOMContentLoaded', () => {  
            const loginContainer = document.getElementById('loginContainer');  
            const appContainer = document.getElementById('appContainer');  
            const loginForm = document.getElementById('loginForm');  
            const errorMessage = document.getElementById('errorMessage');  
            const logoutBtn = document.getElementById('logoutBtn');  

            // Listen auth state and toggle UI  
            onAuthStateChanged(auth, (user) => {  
                if (user) {  
                    loginContainer.style.display = 'none';  
                    appContainer.style.display = 'block';  
                } else {  
                    loginContainer.style.display = 'block';  
                    appContainer.style.display = 'none';  
                }  
            });  

            // Login form submit  
            loginForm.addEventListener('submit', async (e) => {  
                e.preventDefault();  
                errorMessage.textContent = '';  

                const email = loginForm.email.value.trim();  
                const password = loginForm.password.value;  

                try {  
                    await signInWithEmailAndPassword(auth, email, password);  
                    loginForm.reset();  
                } catch (error) {  
                    errorMessage.textContent = 'Login gagal: ' + error.message;  
                }  
            });  

            // Logout button  
            logoutBtn.addEventListener('click', () => {  
                signOut(auth);  
            });  

            // Override Simpan invoice button to save to Firestore with user id  
            const saveBtn = document.getElementById('saveInvoice');  

            saveBtn.addEventListener('click', async () => {  
                const user = auth.currentUser;  
                if (!user) {  
                    alert("Anda harus login terlebih dahulu!");  
                    return;  
                }  

                // Validasi invoice  
                const clientName = document.getElementById('clientName').value.trim();  
                const itemList = document.getElementById('itemList');  

                if (!clientName) {  
                    alert('Silakan isi nama klien terlebih dahulu!');  
                    return;  
                }  
                if (itemList.rows.length === 0) {  
                    alert('Silakan tambahkan minimal satu item terlebih dahulu!');  
                    return;  
                }  

                // Prepare data  
                const invoiceData = {  
                    userId: user.uid,  
                    company: {  
                        name: document.getElementById('companyName').value.trim(),  
                        address: document.getElementById('companyAddress').value.trim(),  
                        phone: document.getElementById('companyPhone').value.trim()  
                    },  
                    invoiceNumber: document.getElementById('invoiceNumber').value.trim(),  
                    invoiceDate: document.getElementById('invoiceDate').value.trim(),  
                    currency: document.getElementById('currency').value,  
                    client: {  
                        name: clientName,  
                        phone: document.getElementById('clientPhone').value.trim(),  
                        address: document.getElementById('clientAddress').value.trim()  
                    },  
                    notes: document.getElementById('notes').value.trim(),  
                    totalAmount: window.totalAmount || 0,  
                    items: [],  
                    createdAt: serverTimestamp()  
                };  

                for (let i = 0; i < itemList.rows.length; i++) {  
                    const row = itemList.rows[i];  
                    invoiceData.items.push({  
                        name: row.dataset.name,  
                        quantity: parseInt(row.dataset.quantity),  
                        price: parseFloat(row.dataset.price),  
                        subtotal: parseInt(row.dataset.quantity) * parseFloat(row.dataset.price)  
                    });  
                }  

                try {  
                    await addDoc(collection(db, "invoices"), invoiceData);  
                    alert("Invoice berhasil disimpan online!");  
                    window.resetForm(); // Panggil reset original setelah simpan  
                } catch (err) {  
                    alert("Gagal menyimpan invoice: " + err.message);  
                }  
            });  
        });  
    </script>  
</head>  
<body>  

    <!-- Halaman Login -->  
    <div id="loginContainer">  
        <h2>Login ke Aplikasi</h2>  
        <form id="loginForm">  
            <input type="email" name="email" id="email" placeholder="Email" required />  
            <input type="password" name="password" id="password" placeholder="Password" required />  
            <button type="submit">Login</button>  
            <div id="errorMessage"></div>  
        </form>  
    </div>  

    <!-- Main aplikasi invoice, sembunyikan dulu -->  
    <div id="appContainer" style="display:none;">  
        <button id="logoutBtn">Logout</button>  

        <div class="container">  
            <div class="no-print">  
                <h1>Aplikasi Input Invoice</h1>  
            </div>  
            
            <div class="print-header" style="display: none;">  
                <h1>INVOICE</h1>  
                <div class="print-company-info">  
                    <p>Firman Grup</p>  
                    <p>Kota Metro</p>  
                    <p>Telepon: 082379821111</p>  
                    <p>No. Invoice: <span id="printInvoiceNumber"></span></p>  
                    <p>Tanggal: <span id="printInvoiceDate"></span></p>  
                </div>  
            </div>  
            
            <form id="invoiceForm">  
                <div class="no-print">  
                    <div class="form-grid">  
                        <div class="form-section">  
                            <h2>Informasi Perusahaan</h2>  
                            <div class="form-group">  
                                <label for="companyName">Nama Perusahaan</label>  
                                <input type="text" id="companyName" value="Firman Grup" required />  
                            </div>  
                            <div class="form-group">  
                                <label for="companyAddress">Alamat</label>  
                                <input type="text" id="companyAddress" value="Kota Metro" required />  
                            </div>  
                            <div class="form-group">  
                                <label for="companyPhone">Telepon</label>  
                                <input type="tel" id="companyPhone" value="082379821111" required />  
                            </div>  
                        </div>  
                        
                        <div class="form-section">  
                            <h2>Informasi Invoice</h2>  
                            <div class="form-group">  
                                <label for="invoiceNumber">Nomor Invoice</label>  
                                <input type="text" id="invoiceNumber" placeholder="Nomor Invoice" required />  
                            </div>  
                            <div class="form-group">  
                                <label for="invoiceDate">Tanggal</label>  
                                <input type="text" id="invoiceDate" required readonly />  
                            </div>  
                            <div class="form-group">  
                                <label for="currency">Mata Uang</label>  
                                <select id="currency">  
                                    <option value="IDR">IDR</option>  
                                    <option value="USD">USD</option>  
                                    <option value="EUR">EUR</option>  
                                </select>  
                            </div>  
                        </div>  
                    </div>  
                    
                    <div class="form-section">  
                        <h2>Informasi Klien</h2>  
                        <div class="form-grid">  
                            <div class="form-group">  
                                <label for="clientName">Nama Klien</label>  
                                <input type="text" id="clientName" placeholder="Nama Klien" required />  
                            </div>  
                            <div class="form-group">  
                                <label for="clientPhone">Telepon Klien</label>  
                                <input type="tel" id="clientPhone" placeholder="Nomor Telepon Klien" required />  
                            </div>  
                        </div>  
                        <div class="form-group">  
                            <label for="clientAddress">Alamat Klien</label>  
                            <input type="text" id="clientAddress" placeholder="Alamat Klien" required />  
                        </div>  
                    </div>  
        
                    <div class="form-section item-form">  
                        <h2>Tambah Item</h2>  
                        <div class="item-form-grid">  
                            <div class="form-group">  
                                <label for="itemName">Nama Barang</label>  
                                <input type="text" id="itemName" placeholder="Nama Barang" required />  
                            </div>  
                            <div class="form-group">  
                                <label for="itemQuantity">Jumlah</label>  
                                <input type="number" id="itemQuantity" placeholder="Jumlah" required min="1" />  
                            </div>  
                            <div class="form-group">  
                                <label for="itemPrice">Harga</label>  
                                <input type="text" id="itemPrice" placeholder="Harga" required />  
                            </div>  
                            <div>  
                                <button type="button" id="addItem">Tambah ke Daftar</button>  
                                <button type="button" id="updateItem" style="display:none; background-color: #ffc107; color: black;">Update Item</button>  
                                <input type="hidden" id="editItemIndex" value="" />  
                            </div>  
                        </div>  
                    </div>  
                </div>  
        
                <h2>Daftar Item</h2>  
                <div style="overflow-x: auto;">  
                    <table>  
                        <thead>  
                            <tr>  
                                <th>No</th>  
                                <th>Nama Barang</th>  
                                <th>Jumlah</th>  
                                <th>Harga</th>  
                                <th>Subtotal</th>  
                                <th class="no-print">Aksi</th>  
                            </tr>  
                        </thead>  
                        <tbody id="itemList">  
                            <!-- Daftar item akan dimasukkan di sini -->  
                        </tbody>  
                    </table>  
                </div>  
        
                <div class="total">Total: <span id="totalAmount">0</span></div>  
                
                <h2>Catatan</h2>  
                <textarea id="notes" placeholder="Catatan tambahan..."></textarea>  
        
                <div class="footer">  
                    <div class="signature">  
                        <p>Diterima oleh,</p>  
                        <br /><br />  
                        <p>________________</p>  
                        <p>Nama Jelas & Cap</p>  
                    </div>  
                    <div class="signature">  
                        <p>Hormat Kami,</p>  
                        <br /><br />  
                        <p>________________</p>  
                        <p>Manager Keuangan</p>  
                    </div>  
                </div>  
        
                <div class="actions no-print">  
                    <button type="button" id="resetForm">Reset</button>  
                    <button type="button" id="saveInvoice">Simpan</button>  
                    <button type="button" id="printInvoice">Cetak Invoice</button>  
                </div>  
            </form>  
        </div>  
    </div>  

<script>  
    // ==== Semua function dan logic script Anda tetap sama ====  

    // Set tanggal otomatis dalam format dd/mm/yyyy  
    function setCurrentDate() {  
        const today = new Date();  
        const day = String(today.getDate()).padStart(2, '0');  
        const month = String(today.getMonth() + 1).padStart(2, '0');  
        const year = today.getFullYear();  
        
        document.getElementById('invoiceDate').value = `${day}/${month}/${year}`;  
    }  
    
    // Generate nomor invoice  
    function generateInvoiceNumber() {  
        const today = new Date();  
        const year = today.getFullYear();  
        const month = String(today.getMonth() + 1).padStart(2, '0');  
        const day = String(today.getDate()).padStart(2, '0');  
        const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');  
        
        return `INV-${year}${month}${day}-${random}`;  
    }  
    
    // Format angka dengan pemisah ribuan  
    function formatNumber(num) {  
        return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");  
    }  
    
    // Unformat angka dari string dengan pemisah ribuan  
    function unformatNumber(str) {  
        return parseFloat(str.replace(/\./g, '').replace(',', '.'));  
    }  
    
    // Event listener untuk format harga dengan pemisah ribuan  
    document.getElementById('itemPrice').addEventListener('input', function(e) {  
        // Hapus karakter non-digit kecuali titik  
        let value = this.value.replace(/[^\d]/g, '');  
        
        // Konversi ke angka  
        let number = parseInt(value);  
        
        // Format dengan pemisah ribuan jika angka valid  
        if (!isNaN(number)) {  
            this.value = formatNumber(number);  
        } else {  
            this.value = '';  
        }  
    });  
    
    // Reset form  
    window.resetForm = function() {  
        // Kembali ke nilai default untuk informasi perusahaan  
        document.getElementById('companyName').value = 'Firman Grup';  
        document.getElementById('companyAddress').value = 'Kota Metro';  
        document.getElementById('companyPhone').value = '082379821111';  
        
        // Reset informasi invoice  
        document.getElementById('invoiceNumber').value = generateInvoiceNumber();  
        setCurrentDate();  
        
        // Reset informasi klien  
        document.getElementById('clientName').value = '';  
        document.getElementById('clientAddress').value = '';  
        document.getElementById('clientPhone').value = '';  
        
        // Reset form item  
        document.getElementById('itemName').value = '';  
        document.getElementById('itemQuantity').value = '';  
        document.getElementById('itemPrice').value = '';  
        
        // Reset daftar item  
        document.getElementById('itemList').innerHTML = '';  
        
        // Reset total  
        window.totalAmount = 0;  
        document.getElementById('totalAmount').textContent = '0';  
        
        // Reset catatan  
        document.getElementById('notes').value = '';  
        
        // Reset item counter  
        window.itemCounter = 1;  
        
        // Reset mode edit  
        exitEditMode();  
    }  
    
    // Inisialisasi saat halaman dimuat  
    window.onload = function() {  
        setCurrentDate();  
        document.getElementById('invoiceNumber').value = generateInvoiceNumber();  
    };  
    
    // Fungsi untuk menambahkan item ke daftar  
    window.itemCounter = 1;  
    window.totalAmount = 0;  
    
    function addItemToList() {  
        const itemName = document.getElementById('itemName').value;  
        const itemQuantity = parseInt(document.getElementById('itemQuantity').value);  
        const itemPriceStr = document.getElementById('itemPrice').value;  
        const itemPrice = unformatNumber(itemPriceStr);  
        
        if (itemName && !isNaN(itemQuantity) && !isNaN(itemPrice) && itemQuantity > 0 && itemPrice >= 0) {  
            const subtotal = itemQuantity * itemPrice;  
            const tableRow = document.createElement('tr');  
            tableRow.dataset.name = itemName;  
            tableRow.dataset.quantity = itemQuantity;  
            tableRow.dataset.price = itemPrice;  
            
            tableRow.innerHTML = `  
                <td>${window.itemCounter}</td>  
                <td>${itemName}</td>  
                <td>${itemQuantity}</td>  
                <td class="right">${formatNumber(itemPrice)}</td>  
                <td class="right">${formatNumber(subtotal)}</td>  
                <td class="no-print">  
                    <button type="button" class="editBtn">Edit</button>  
                    <button type="button" class="deleteBtn">Hapus</button>  
                </td>  
            `;  
            
            document.getElementById('itemList').appendChild(tableRow);  
            
            // Reset form item  
            document.getElementById('itemName').value = '';  
            document.getElementById('itemQuantity').value = '';  
            document.getElementById('itemPrice').value = '';  
            
            // Update counter dan total  
            window.itemCounter++;  
            window.totalAmount += subtotal;  
            document.getElementById('totalAmount').textContent = formatNumber(window.totalAmount);  
            
            // Tambahkan event listener untuk tombol  
            addButtonListeners(tableRow);  
            
            return true;  
        } else {  
            alert('Silakan isi semua data item dengan benar!');  
            return false;  
        }  
    }  
    
    function addButtonListeners(tableRow) {  
        // Event listener untuk tombol hapus  
        const deleteButton = tableRow.querySelector('.deleteBtn');  
        deleteButton.addEventListener('click', function() {  
            const row = this.closest('tr');  
            const rowSubtotal = unformatNumber(row.cells[4].textContent);  
            
            window.totalAmount -= rowSubtotal;  
            document.getElementById('totalAmount').textContent = formatNumber(window.totalAmount);  
            
            row.remove();  
            
            // Re-number rows  
            const rows = document.getElementById('itemList').rows;  
            for (let i = 0; i < rows.length; i++) {  
                rows[i].cells[0].textContent = i + 1;  
            }  
            
            window.itemCounter = rows.length + 1;  
            
            // Keluar dari mode edit jika sedang edit item yang dihapus  
            if (document.getElementById('editItemIndex').value) {  
                exitEditMode();  
            }  
        });  
        
        // Event listener untuk tombol edit  
        const editButton = tableRow.querySelector('.editBtn');  
        editButton.addEventListener('click', function() {  
            const row = this.closest('tr');  
            const rowIndex = row.rowIndex;  
            
            // Isi form dengan data item  
            document.getElementById('itemName').value = row.dataset.name;  
            document.getElementById('itemQuantity').value = row.dataset.quantity;  
            document.getElementById('itemPrice').value = formatNumber(row.dataset.price);  
            
            // Simpan index row yang sedang diedit  
            document.getElementById('editItemIndex').value = rowIndex;  
            
            // Tampilkan tombol update, sembunyikan tombol tambah  
            document.getElementById('addItem').style.display = 'none';  
            document.getElementById('updateItem').style.display = 'inline-block';  
            
            // Scroll ke form  
            document.getElementById('itemName').scrollIntoView({behavior: 'smooth'});  
        });  
    }  
    
    function exitEditMode() {  
        document.getElementById('editItemIndex').value = '';  
        document.getElementById('addItem').style.display = 'inline-block';  
        document.getElementById('updateItem').style.display = 'none';  
    }  
    
    // Event listener untuk tombol tambah item  
    document.getElementById('addItem').addEventListener('click', function() {  
        addItemToList();  
    });  
    
    // Event listener untuk tombol update item  
    document.getElementById('updateItem').addEventListener('click', function() {  
        const rowIndex = document.getElementById('editItemIndex').value;  
        if (!rowIndex) return;  
        
        const itemName = document.getElementById('itemName').value;  
        const itemQuantity = parseInt(document.getElementById('itemQuantity').value);  
        const itemPriceStr = document.getElementById('itemPrice').value;  
        const itemPrice = unformatNumber(itemPriceStr);  
        
        if (itemName && !isNaN(itemQuantity) && !isNaN(itemPrice) && itemQuantity > 0 && itemPrice >= 0) {  
            const rows = document.getElementById('itemList').rows;  
            const row = rows[rowIndex - 1]; // -1 karena rowIndex dimulai dari 1, sedangkan array dimulai dari 0  
            
            if (row) {  
                const oldSubtotal = unformatNumber(row.cells[4].textContent);  
                const newSubtotal = itemQuantity * itemPrice;  
                
                window.totalAmount = window.totalAmount - oldSubtotal + newSubtotal;  
                document.getElementById('totalAmount').textContent = formatNumber(window.totalAmount);  
                
                row.dataset.name = itemName;  
                row.dataset.quantity = itemQuantity;  
                row.dataset.price = itemPrice;  
                
                row.cells[1].textContent = itemName;  
                row.cells[2].textContent = itemQuantity;  
                row.cells[3].textContent = formatNumber(itemPrice);  
                row.cells[4].textContent = formatNumber(newSubtotal);  
                
                document.getElementById('itemName').value = '';  
                document.getElementById('itemQuantity').value = '';  
                document.getElementById('itemPrice').value = '';  
                
                exitEditMode();  
            }  
        } else {  
            alert('Silakan isi semua data item dengan benar!');  
        }  
    });  
    
    // Event listener untuk tombol reset  
    document.getElementById('resetForm').addEventListener('click', function() {  
        if (confirm('Anda yakin ingin mereset seluruh form?')) {  
            resetForm();  
        }  
    });  
    
    // Fungsi untuk cetak invoice  
    document.getElementById('printInvoice').addEventListener('click', function() {  
        const clientName = document.getElementById('clientName').value;  
        if (!clientName) {  
            alert('Silakan isi informasi klien terlebih dahulu!');  
            return;  
        }  
        if (document.getElementById('itemList').rows.length === 0) {  
            alert('Silakan tambahkan minimal satu item terlebih dahulu!');  
            return;  
        }  
        document.querySelector('.print-header').style.display = 'block';  
        document.getElementById('printInvoiceNumber').textContent = document.getElementById('invoiceNumber').value;  
        document.getElementById('printInvoiceDate').textContent = document.getElementById('invoiceDate').value;  
        window.print();  
        setTimeout(function() {  
            document.querySelector('.print-header').style.display = 'none';  
        }, 1000);  
    });  
    
    document.getElementById('printInvoice').addEventListener('click', function() {  
        const notes = document.getElementById('notes');  
        const notesOriginalHeight = notes.style.height;  
        if (notes.value.length > 100) {  
            notes.style.height = '60px';  
        } else if (notes.value.length > 0) {  
            notes.style.height = '40px';  
        } else {  
            notes.style.height = '20px';  
        }  
        setTimeout(function() {  
            notes.style.height = notesOriginalHeight;  
        }, 1000);  
    });  
    
    // Enter key pada item form tambah item  
    document.getElementById('itemPrice').addEventListener('keypress', function(e) {  
        if (e.key === 'Enter') {  
            e.preventDefault();  
            if (document.getElementById('updateItem').style.display === 'inline-block') {  
                document.getElementById('updateItem').click();  
            } else {  
                document.getElementById('addItem').click();  
            }  
        }  
    });  
</script>  

</body>  
</html>
