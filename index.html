<!DOCTYPE html>  
<html lang="id">  
<head>  
    <meta charset="UTF-8">  
    <meta name="viewport" content="width=device-width, initial-scale=1.0">  
    <title>Undangan Pernikahan Firman & Resti</title>  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">  
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">  
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">  
    <style>  
        /* Style Anda tetap sama */  
    </style>  
</head>  
<body>  
    <div class="container py-4">  
        <div class="row justify-content-center">  
            <div class="col-md-10 col-lg-8">  
                <div class="card card-custom">  
                    <div class="card-body p-4">  
                        <!-- Bagian Autentikasi -->  
                        <div id="auth-section">  
                            <h2 class="text-center mb-4">üéâ Undangan Pernikahan</h2>  
                            <form id="auth-form">  
                                <div class="mb-3">  
                                    <label class="form-label">Email</label>  
                                    <input type="email" id="email" class="form-control" required>  
                                </div>  
                                <div class="mb-3">  
                                    <label class="form-label">Password</label>  
                                    <input type="password" id="password" class="form-control" required>  
                                </div>  
                                <div class="d-grid gap-2">  
                                    <button type="button" onclick="login()" class="btn btn-custom">Login</button>  
                                    <button type="button" onclick="register()" class="btn btn-outline-primary">Registrasi</button>  
                                </div>  
                            </form>  
                        </div>  

                        <!-- Bagian Setelah Login -->  
                        <div id="undangan-section" style="display:none;">  
                            <!-- Nav Tab -->  
                            <ul class="nav nav-tabs mb-3" id="myTab" role="tablist">  
                                <li class="nav-item" role="presentation">  
                                    <button class="nav-link active" id="undangan-tab" data-bs-toggle="tab"   
                                            data-bs-target="#undangan" type="button">Undangan</button>  
                                </li>  
                                <li class="nav-item" role="presentation">  
                                    <button class="nav-link" id="daftar-tab" data-bs-toggle="tab"   
                                            data-bs-target="#daftar" type="button">Daftar Tamu</button>  
                                </li>  
                            </ul>  

                            <!-- Tab Content -->  
                            <div class="tab-content" id="myTabContent">  
                                <!-- Tab Undangan -->  
                                <div class="tab-pane fade show active" id="undangan">  
                                    <h3 class="text-center mb-4">üìù Tambah Tamu</h3>  
                                    <div class="row g-3">  
                                        <div class="col-md-6">  
                                            <label class="form-label">Nama Tamu</label>  
                                            <input type="text" id="nama-tamu" class="form-control" placeholder="Masukkan nama tamu">  
                                        </div>  
                                        <div class="col-md-6">  
                                            <label class="form-label">Lokasi</label>  
                                            <input type="text" id="lokasi-tamu" class="form-control" placeholder="Asal/Lokasi">  
                                        </div>  
                                        <div class="col-12">  
                                            <label class="form-label">Status Kehadiran</label>  
                                            <select id="status-tamu" class="form-select">  
                                                <option value="Belum Konfirmasi">Belum Konfirmasi</option>  
                                                <option value="Hadir">Hadir</option>  
                                                <option value="Tidak Hadir">Tidak Hadir</option>  
                                            </select>  
                                        </div>  
                                        <div class="col-12">  
                                            <button onclick="tambahTamu()" class="btn btn-custom w-100">  
                                                + Tambah Tamu  
                                            </button>  
                                        </div>  
                                    </div>  
                                </div>  

                                <!-- Tab Daftar Tamu -->  
                                <div class="tab-pane fade" id="daftar">  
                                    <div class="d-flex justify-content-between align-items-center mb-3">  
                                        <h4 class="m-0">Daftar Tamu</h4>  
                                        <div>  
                                            <span class="badge bg-primary me-2" id="total-tamu">0 Tamu</span>  
                                            <button onclick="cetakDaftarTamu()" class="btn btn-success btn-sm">  
                                                <i class="bi bi-printer"></i> Cetak  
                                            </button>  
                                        </div>  
                                    </div>  
                                    <div class="table-responsive">  
                                        <table class="table table-striped table-hover">  
                                            <thead>  
                                                <tr>  
                                                    <th>Nama</th>  
                                                    <th>Lokasi</th>  
                                                    <th>Status</th>  
                                                    <th>Aksi</th>  
                                                </tr>  
                                            </thead>  
                                            <tbody id="tabel-daftar-tamu">  
                                                <!-- Isi tabel akan ditambahkan secara dinamis -->  
                                            </tbody>  
                                        </table>  
                                    </div>  
                                    
                                    <!-- Tambahan Tombol Simpan -->  
                                    <div class="mt-3 text-center">  
                                        <button onclick="simpanDaftarTamu()" class="btn btn-primary">  
                                            <i class="bi bi-save"></i> Simpan Daftar Tamu  
                                        </button>  
                                        <button onclick="muatDaftarTamu()" class="btn btn-secondary ms-2">  
                                            <i class="bi bi-download"></i> Muat Daftar Tamu  
                                        </button>  
                                    </div>  
                                </div>  
                            </div>  
                        </div>  
                    </div>  
                </div>  
            </div>  
        </div>  
    </div>  

    <!-- Library -->  
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>  
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>  
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>  

    <script>  
        // Konfigurasi Firebase (tetap sama)  
        const firebaseConfig = {  
            apiKey: "AIzaSyCRm31FJaqEbjL_MqMKKiiQRlurYenc4Dc",  
            authDomain: "project-baru-28a4a.firebaseapp.com",  
            projectId: "project-baru-28a4a",  
            storageBucket: "project-baru-28a4a.firebasestorage.app",  
            messagingSenderId: "1046595689835",  
            appId: "1:1046595689835:web:5c7eb22e357e36ff11802e"  
        };  

        // Inisialisasi Firebase  
        firebase.initializeApp(firebaseConfig);  
        const auth = firebase.auth();  
        const database = firebase.database();  

        // Array untuk menyimpan daftar tamu  
        let daftarTamu = [];  

        // Fungsi Login (tambahkan observasi status login)  
        function login() {  
            const email = document.getElementById('email').value;  
            const password = document.getElementById('password').value;  

            auth.signInWithEmailAndPassword(email, password)  
                .then((userCredential) => {  
                    Swal.fire({  
                        icon: 'success',  
                        title: 'Login Berhasil!',  
                        toast: true,  
                        position: 'top-end',  
                        showConfirmButton: false,  
                        timer: 1500  
                    });  
                    document.getElementById('auth-section').style.display = 'none';  
                    document.getElementById('undangan-section').style.display = 'block';  
                    
                    // Muat daftar tamu saat login  
                    muatDaftarTamu();  
                })  
                .catch((error) => {  
                    Swal.fire({  
                        icon: 'error',  
                        title: 'Login Gagal',  
                        text: error.message  
                    });  
                });  
        }  

        // Fungsi Simpan Daftar Tamu (diperbarui)  
        function simpanDaftarTamu() {  
            // Pastikan user sudah login  
            const user = auth.currentUser;  
            if (!user) {  
                Swal.fire({  
                    icon: 'warning',  
                    title: 'Anda Belum Login',  
                    text: 'Silakan login terlebih dahulu'  
                });  
                return;  
            }  

            if (daftarTamu.length === 0) {  
                Swal.fire({  
                    icon: 'warning',  
                    title: 'Daftar Tamu Kosong',  
                    text: 'Silakan tambahkan minimal satu tamu'  
                });  
                return;  
            }  

            const undanganRef = database.ref('undangan_firman_resti/daftar_tamu/' + user.uid);  
            
            undanganRef.set(daftarTamu)  
                .then(() => {  
                    Swal.fire({  
                        icon: 'success',  
                        title: 'Daftar Tamu Tersimpan',  
                        text: `Berhasil menyimpan ${daftarTamu.length} tamu`  
                    });  
                })  
                .catch((error) => {  
                    Swal.fire({  
                        icon: 'error',  
                        title: 'Gagal Menyimpan',  
                        text: error.message  
                    });  
                });  
        }  

        // Fungsi Muat Daftar Tamu (baru)  
        function muatDaftarTamu() {  
            const user = auth.currentUser;  
            if (!user) {  
                Swal.fire({  
                    icon: 'warning',  
                    title: 'Anda Belum Login',  
                    text: 'Silakan login terlebih dahulu'  
                });  
                return;  
            }  

            const undanganRef = database.ref('undangan_firman_resti/daftar_tamu/' + user.uid);  
            
            undanganRef.once('value')  
                .then((snapshot) => {  
                    const data = snapshot.val();  
                    if (data) {  
                        // Reset tabel  
                        document.getElementById('tabel-daftar-tamu').innerHTML = '';  
                        
                        // Reset array  
                        daftarTamu = [];  
                        
                        // Tambahkan data yang dimuat  
                        data.forEach(tamu => {  
                            tambahTamuDariDatabase(tamu);  
                        });  

                        Swal.fire({  
                            icon: 'success',  
                            title: 'Daftar Tamu Dimuat',  
                            text: `Berhasil memuat ${data.length} tamu`  
                        });  
                    } else {  
                        Swal.fire({  
                            icon: 'info',  
                            title: 'Tidak Ada Data',  
                            text: 'Belum ada daftar tamu yang tersimpan'  
                        });  
                    }  
                })  
                .catch((error) => {  
                    Swal.fire({  
                        icon: 'error',  
                        title: 'Gagal Memuat',  
                        text: error.message  
                    });  
                });  
        }  

        // Fungsi tambahan untuk menambah tamu dari database  
        function tambahTamuDariDatabase(tamu) {  
            daftarTamu.push(tamu);  

            const tabelDaftarTamu = document.getElementById('tabel-daftar-tamu');  
            const tr = document.createElement('tr');  
            tr.innerHTML = `  
                <td>${tamu.nama}</td>  
                <td>${tamu.lokasi}</td>  
                <td>  
                    <span class="badge ${  
                        tamu.status === 'Hadir' ? 'bg-success' :   
                        tamu.status === 'Tidak Hadir' ? 'bg-danger' : 'bg-warning'  
                    }">  
                        ${tamu.status}  
                    </span>  
                </td>  
                <td>  
                    <div class="btn-group" role="group">  
                        <button onclick="editTamu(${tamu.id})" class="btn btn-warning btn-sm">  
                            <i class="bi bi-pencil"></i> Edit  
                        </button>  
                        <button onclick="hapusTamu(${tamu.id})" class="btn btn-danger btn-sm">  
                            <i class="bi bi-trash"></i> Hapus  
                        </button>  
                    </div>  
                </td>  
            `;  
            tabelDaftarTamu.appendChild(tr);  

            // Update total tamu  
            document.getElementById('total-tamu').textContent = `${daftarTamu.length} Tamu`;  
        }  

        // Sisa fungsi tetap sama dengan kode sebelumnya  
        // ... (tambahTamu, editTamu, hapusTamu, dll)  
    </script>  
</body>  
</html>
